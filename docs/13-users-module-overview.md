# 13. نظرة عامة على وحدة المستخدمين والصلاحيات

توفر `Flask-DevKit` نظامًا متكاملاً وقويًا لإدارة المستخدمين والمصادقة والتحكم في الوصول المستند إلى الأدوار (Role-Based Access Control - RBAC) بشكل افتراضي. الهدف من هذه الوحدة هو توفير حل آمن وجاهز للاستخدام يغنيك عن بناء هذه الميزات المعقدة من الصفر.

## نموذج التحكم في الوصول (RBAC Model)

تعتمد الوحدة على نموذج بسيط وفعال يتكون من ثلاثة مكونات أساسية: المستخدمين (Users)، والأدوار (Roles)، والصلاحيات (Permissions).

```
┌────────┐      ┌────────┐      ┌─────────────┐
│  User  │◄───┬──┤  Role  │◄───┬──┤ Permission  │
└────────┘    │  └────────┘    │  └─────────────┘
              │                │
      (يُعيّن له)        (تُمنح له)
```

- **الصلاحية (Permission):** هي الإذن للقيام بفعل معين. يتم تمثيلها كسلسلة نصية، على سبيل المثال: `create:user` أو `read:product`.
- **الدور (Role):** هو مجموعة من الصلاحيات. على سبيل المثال، يمكن أن يحتوي دور "المحرر" (Editor) على صلاحيات `create:post` و `update:post`.
- **المستخدم (User):** هو الكيان الذي يقوم بتسجيل الدخول. يتم تعيين الأدوار للمستخدمين.

**القاعدة الأساسية:** يرث المستخدم جميع الصلاحيات من جميع الأدوار المعينة له. إذا كان المستخدم "أحمد" لديه دور "محرر"، فإنه يكتسب تلقائيًا صلاحيات `create:post` و `update:post`.

## المكونات المدمجة

عندما تقوم بتهيئة `DevKit`، تحصل على المكونات التالية الجاهزة للعمل:

1.  **نماذج قاعدة البيانات (`models.py`):**
    - `User`: لتخزين معلومات المستخدمين وكلمات المرور المجزأة (hashed).
    - `Role`: لتخزين الأدوار المتاحة في النظام.
    - `Permission`: لتخزين جميع الصلاحيات الممكنة.
    - جداول ربط لإدارة العلاقات بين هذه النماذج.

2.  **خدمات منطق الأعمال (`services.py`):**
    - `UserService`: لإدارة منطق إنشاء المستخدمين، تسجيل الدخول، تغيير كلمة المرور، إلخ.
    - `RoleService`: لإدارة الأدوار وتعيينها للمستخدمين.
    - `PermissionService`: لإدارة الصلاحيات وربطها بالأدوار.

3.  **نقاط نهاية REST API (`routes.py`):**
    - **`/auth`**: لتسجيل الدخول (`/login`)، تحديث التوكن (`/refresh`)، والحصول على معلومات المستخدم الحالي (`/me`).
    - **`/users`**: واجهة CRUD كاملة لإدارة المستخدمين.
    - **`/roles`**: واجهة CRUD كاملة لإدارة الأدوار، بالإضافة إلى نقاط نهاية لتعيين/إلغاء تعيين الصلاحيات للمستخدمين والأدوار.
    - **`/permissions`**: واجهة CRUD كاملة لإدارة الصلاحيات.

4.  **أوامر واجهة سطر الأوامر (CLI):**
    - `flask devkit-seed`: أمر حيوي يقوم بملء قاعدة البيانات بمجموعة من الصلاحيات الافتراضية، ودور "admin" يمتلك كل الصلاحيات، وإنشاء مستخدم مسؤول أول.

ببساطة، بمجرد تشغيل `devkit.init_app(app)` و `flask devkit-seed`، يكون لديك نظام مصادقة وتحكم في الوصول كامل وجاهز للاستخدام والتوسيع.

## تخصيص المسارات (Customizing Routes)

في بعض الحالات، قد ترغب في تعطيل أو تعديل المسارات الافتراضية التي توفرها `Flask-DevKit`. على سبيل المثال، قد ترغب في استخدام نظام مصادقة مختلف وتعطيل مسار `/auth/login` الافتراضي، أو تغيير عنوان URL لمسار معين.

يمكنك تحقيق ذلك عن طريق تمرير قاموس `routes_config` إلى `DevKit` عند تهيئة التطبيق. يتيح لك هذا القاموس تجاوز أي من المعلمات المستخدمة في دالة `register_custom_route`.

**مثال: تعطيل مسار تسجيل الدخول**

```python
# In your app factory
from flask_devkit import DevKit

routes_config = {
    "user": {
        "login": {"enabled": False} # تعطيل المسار
    }
}

devkit = DevKit()
# "user" is the service_name
devkit.register_routes_config("user", routes_config["user"])
devkit.init_app(app)
```

**مثال: تعديل مسار وإضافة صلاحية**

يمكنك أيضًا تجاوز أي من المعلمات الأخرى لـ `register_custom_route`، مثل `rule`، `methods`، `permission`، و `decorators`.

```python
routes_config = {
    "user": {
        "login": {
            "rule": "/signin", # تغيير عنوان URL
            "methods": ["POST"],
        },
        "whoami": {
            "permission": "read:self" # إضافة صلاحية مخصصة
        }
    }
}

devkit = DevKit()
devkit.register_routes_config("user", routes_config["user"])
devkit.init_app(app)
```

في هذا المثال، قمنا بتغيير مسار تسجيل الدخول من `/auth/login` إلى `/auth/signin`، وأضفنا صلاحية `read:self` إلى مسار `/auth/me`.
