# 14. نماذج قاعدة البيانات لوحدة المستخدمين

تشكل النماذج التالية بنية قاعدة البيانات لنظام المصادقة والتحكم في الوصول. تم بناؤها باستخدام `SQLAlchemy` وتستخدم الـ `Mixins` الأساسية للمكتبة (`IDMixin`, `UUIDMixin`, etc.).

## 1. نموذج `User`

يمثل هذا النموذج مستخدمًا فرديًا في النظام يمكنه تسجيل الدخول.

### الحقول الهامة

- `id` (Integer, PK): المعرف الرقمي الأساسي.
- `uuid` (String, Unique): المعرف الفريد العالمي، يُستخدم في واجهات الـ API.
- `username` (String, Unique): اسم المستخدم لتسجيل الدخول.
- `password_hash` (String): تجزئة (hash) آمنة لكلمة المرور. لا يتم تخزين كلمات المرور كنص عادي أبدًا.
- `is_active` (Boolean): علم (flag) لتحديد ما إذا كان حساب المستخدم نشطًا. يمكن للمستخدمين غير النشطين تسجيل الدخول.
- `last_login_at` (Timestamp): طابع زمني لآخر مرة قام فيها المستخدم بتسجيل الدخول بنجاح.
- `deleted_at` (Timestamp): يُستخدم للحذف الناعم (Soft Delete).

### التوابع (Methods)

- **`set_password(password: str)`**: تأخذ كلمة مرور كنص عادي، وتقوم بتجزئتها (hashing) بأمان، وتخزينها في حقل `password_hash`.
- **`check_password(password: str) -> bool`**: تقارن كلمة مرور كنص عادي مع التجزئة المخزنة وتُرجع `True` إذا تطابقتا.

### العلاقات (Relationships)

- **`roles`**: تُرجع قائمة بكائنات `Role` المعينة لهذا المستخدم.

## 2. نموذج `Role`

يمثل الدور مجموعة من الصلاحيات التي يمكن تعيينها للمستخدمين.

### الحقول الهامة

- `id` (Integer, PK): المعرف الرقمي الأساسي.
- `name` (String, Unique): اسم فريد للدور (e.g., "admin", "editor").
- `display_name` (String): اسم قابل للقراءة للعرض في واجهات المستخدم (e.g., "Administrator").
- `description` (Text): وصف اختياري للدور.
- `is_system_role` (Boolean): علم هام. إذا كان `True`، لا يمكن حذف هذا الدور أو إعادة تسميته عبر واجهة برمجة التطبيقات، مما يحمي الأدوار الحيوية مثل "admin".

### العلاقات

- **`permissions`**: تُرجع قائمة بكائنات `Permission` الممنوحة لهذا الدور.
- **`users`**: تُرجع قائمة بكائنات `User` التي تم تعيين هذا الدور لها.

## 3. نموذج `Permission`

يمثل صلاحية واحدة ومحددة للقيام بفعل ما في النظام.

### الحقول الهامة

- `id` (Integer, PK): المعرف الرقمي الأساسي.
- `name` (String, Unique): اسم الصلاحية الفريد، وعادة ما يتبع صيغة `action:resource` (e.g., `create:user`, `read:post`).
- `description` (Text): وصف اختياري لما تسمح به هذه الصلاحية.

### العلاقات

- **`roles`**: تُرجع قائمة بكائنات `Role` التي تم منحها هذه الصلاحية.

## جداول الربط (Association Tables)

لإدارة علاقات "متعدد إلى متعدد" (Many-to-Many)، تستخدم المكتبة جدولين للربط:

- **`user_roles`**: يربط بين `User` و `Role`.
- **`role_permissions`**: يربط بين `Role` و `Permission`.

لا تحتاج عادةً إلى التفاعل مع هذه الجداول مباشرة، حيث تتم إدارتها من خلال علاقات `SQLAlchemy` في النماذج الرئيسية.
