# 15. خدمة المستخدمين: `UserService`

ترث `UserService` من `BaseService` وتوفر التنفيذ الفعلي لمنطق الأعمال المتعلق بالمستخدمين والمصادقة وإنشاء رموز JWT.

## المسؤوليات الرئيسية

تتولى هذه الخدمة المهام الحيوية التالية:

### 1. إنشاء المستخدمين

عندما تقوم بإنشاء مستخدم جديد عبر `user_service.create(data)`، يتم استدعاء `pre_create_hook` المخصص في هذه الخدمة، والذي يقوم تلقائيًا بالآتي:
- **التحقق من تكرار اسم المستخدم:** يمنع إنشاء مستخدمين بنفس اسم المستخدم.
- **التحقق من قوة كلمة المرور:** يتأكد من أن كلمة المرور لا تقل عن 8 أحرف وتحتوي على أرقام وحروف.
- **تجزئة كلمة المرور:** يقوم بتجزئة (hashing) كلمة المرور بأمان قبل حفظها في قاعدة البيانات.

### 2. مصادقة المستخدم (`login_user`)

هذا التابع هو المسؤول عن عملية تسجيل الدخول. عند استدعائه، يقوم بالخطوات التالية بالترتيب:
1.  البحث عن المستخدم عن طريق `username`.
2.  التحقق من صحة كلمة المرور.
3.  التأكد من أن حساب المستخدم نشط (`is_active` is `True`).
4.  التأكد من أن الحساب غير محذوف (soft-deleted).
5.  إذا نجحت جميع عمليات التحقق، يقوم بتحديث حقل `last_login_at`.
6.  يستدعي `generate_tokens_for_user` لإنشاء رموز `access_token` و `refresh_token`.
7.  في حالة فشل أي خطوة، يتم إطلاق استثناء `AuthenticationError` مع رسالة مناسبة.

### 3. إنشاء رموز JWT (`generate_tokens_for_user`)

هذا التابع مسؤول عن بناء حمولة (payload) رموز JWT. بشكل افتراضي، يضيف المطالبات (claims) الهامة التالية إلى كل `access_token`:

- **`user_id`**: المعرف الرقمي للمستخدم.
- **`roles`**: قائمة بأسماء الأدوار المعينة للمستخدم (e.g., `["admin", "editor"]`).
- **`is_super_admin`**: قيمة `True` إذا كان لدى المستخدم أي دور تم تعيينه كـ `is_system_role`.
- **`permissions`**: قائمة فريدة ومصنفة بجميع الصلاحيات التي يرثها المستخدم من أدواره. هذه القائمة هي التي يستخدمها المُزين `@permission_required` للتحقق من الوصول.

بالإضافة إلى ذلك، إذا قمت بتمرير `additional_claims_loader` عند تهيئة `DevKit`، فسيتم استدعاؤه هنا لدمج أي مطالبات مخصصة قمت بتعريفها.

### 4. إدارة كلمة المرور (`change_password`)

يوفر هذا التابع منطقًا آمنًا لتغيير كلمة المرور. يتطلب من المستخدم تقديم كلمة المرور الحالية والجديدة، ويتحقق من صحة كلمة المرور الحالية قبل السماح بالتغيير.

## التخصيص

`UserService` مصممة ليتم تمديدها. إذا كنت بحاجة إلى تغيير أي من هذا السلوك - على سبيل المثال، لإضافة فحص المصادقة الثنائية (2FA) أثناء تسجيل الدخول، أو لفرض قواعد أكثر صرامة على كلمات المرور - فإن الطريقة الصحيحة هي:
1.  إنشاء فئة `CustomUserService` ترث من `flask_devkit.users.services.UserService`.
2.  تجاوز (override) التابع الذي تريد تغييره (e.g., `login_user`).
3.  تسجيل خدمتك المخصصة باستخدام `devkit.register_service("user", your_custom_service)`.
