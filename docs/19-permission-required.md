# 19. حماية نقاط النهاية: المُزين `@permission_required`

المُزين `@permission_required` هو حارس البوابة لنظام التحكم في الوصول. يتم استخدامه لتزيين دوال المسارات (route functions) لضمان أن المستخدم الذي يقوم بالطلب لديه الإذن المحدد لتنفيذ الإجراء.

## كيف يعمل؟

عندما يتم استدعاء نقطة نهاية محمية بهذا المُزين، فإنه يقوم بالخطوات التالية:

1.  **التحقق من وجود JWT:** يتأكد من وجود `access_token` صالح في الطلب.
2.  **استخلاص المطالبات (Claims):** يقرأ الحمولة (payload) من الـ JWT.
3.  **التحقق من الصلاحية:** يقوم بالتحقق من شرطين:
    - **هل المستخدم مسؤول خارق (Super Admin)؟**
      - يتحقق من مطالبة `is_super_admin` في الـ JWT. إذا كانت `True`، يتم منح الوصول على الفور، متجاوزًا فحص الصلاحية المحدد. (يتم تعيين `is_super_admin` إلى `True` إذا كان لدى المستخدم أي دور نظام `is_system_role=True`).
    - **هل يمتلك المستخدم الصلاحية المطلوبة؟**
      - إذا لم يكن المستخدم مسؤولًا خارقًا، يبحث المُزين في قائمة `permissions` داخل الـ JWT. إذا كانت السلسلة النصية للصلاحية المطلوبة موجودة في القائمة، يتم منح الوصول.
4.  **رفض الوصول:** إذا فشل كلا الشرطين، يطلق المُزين استثناء `PermissionDeniedError`، مما يؤدي إلى إرسال استجابة `403 Forbidden` إلى العميل.

## كيفية الاستخدام

يتم استخدام المُزين مباشرة على دالة المسار، مع تمرير اسم الصلاحية المطلوبة كسلسلة نصية.

**مهم:** يجب دائمًا وضع `@permission_required` **بعد** `@jwt_required()`.

### مثال: حماية نقطة نهاية مخصصة

لنفترض أن لديك نقطة نهاية مخصصة لعرض تقارير مالية حساسة.

```python
from flask import Blueprint
from flask_jwt_extended import jwt_required
from flask_devkit.auth.decorators import permission_required

# افترض أن لديك صلاحية باسم "read:financial_report"
# تم إنشاؤها وتعيينها لدور "accountant".

reports_bp = Blueprint("reports", __name__)

@reports_bp.route("/reports/financial", methods=["GET"])
@jwt_required()
@permission_required("read:financial_report")
def get_financial_reports():
    """
    نقطة النهاية هذه محمية. لن يتم تنفيذ هذا الكود إلا إذا كان
    لدى المستخدم صلاحية "read:financial_report" (أو كان مسؤولاً خارقًا).
    """
    # منطق جلب وعرض التقارير
    return {"data": "secret financial data"}

```

### الاستخدام مع `register_crud_routes`

لا تحتاج إلى تطبيق هذا المُزين يدويًا على نقاط النهاية التي تم إنشاؤها بواسطة `register_crud_routes`. تقوم تلك الدالة بتطبيقه تلقائيًا بناءً على قيمة `permission` التي تحددها في قاموس `routes_config`. هذا المُزين مخصص بشكل أساسي لنقاط النهاية المخصصة التي تقوم بإنشائها بنفسك.
