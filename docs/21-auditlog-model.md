# 21. نموذج سجل التدقيق: `AuditLog`

كل حدث يقوم نظام التدقيق بالتقاطه يتم تخزينه في قاعدة البيانات كنسخة من نموذج `AuditLog`. يتم تخزين هذه السجلات في جدول `devkit_audit_log`.

يوفر هذا النموذج رؤية مفصلة لكل تغيير، مما يجعله أداة قوية للتحليل الأمني وتتبع البيانات.

## حقول النموذج

فيما يلي شرح لكل حقل في نموذج `AuditLog`:

- **`id: Mapped[int]`**
  - **الوصف:** المفتاح الأساسي لسجل التدقيق نفسه.

- **`timestamp: Mapped[datetime.datetime]`**
  - **الوصف:** الطابع الزمني الدقيق الذي حدث فيه التغيير.

- **`user_id: Mapped[int]`**
  - **الوصف:** مفتاح خارجي (foreign key) يشير إلى `id` المستخدم الذي أجرى التغيير. يمكن أن يكون `NULL` إذا تم التغيير من خارج سياق طلب ويب (على سبيل المثال، عبر أمر CLI).

- **`action: Mapped[str]`**
  - **الوصف:** نوع الإجراء الذي تم. تكون القيمة واحدة من: `'CREATE'`, `'UPDATE'`, or `'DELETE'`.

- **`table_name: Mapped[str]`**
  - **الوصف:** اسم جدول قاعدة البيانات الذي تم تعديله (e.g., `"users"`, `"roles"`).

- **`record_pk: Mapped[str]`**
  - **الوصف:** المفتاح الأساسي للسجل الذي تم تعديله. يتم تخزينه كنص ليكون متوافقًا مع أنواع مختلفة من المفاتيح (رقمية، UUID, etc.).

- **`old_values: Mapped[dict]`**
  - **الوصف:** حقل `JSON` يحتوي على قاموس يمثل قيم الحقول **قبل** التغيير.
  - **ملاحظات:**
    - في عملية `UPDATE`، يحتوي فقط على الحقول التي تغيرت بالفعل.
    - في عملية `DELETE`، يحتوي على جميع قيم الحقول قبل الحذف.
    - يكون `NULL` في عملية `CREATE`.

- **`new_values: Mapped[dict]`**
  - **الوصف:** حقل `JSON` يحتوي على قاموس يمثل قيم الحقول **بعد** التغيير.
  - **ملاحظات:**
    - في عملية `UPDATE`، يحتوي فقط على الحقول التي تغيرت بالفعل.
    - في عملية `CREATE`، يحتوي على جميع قيم الحقول للسجل الجديد.
    - يكون `NULL` في عملية `DELETE`.

## العلاقات (Relationships)

- **`user = db.relationship("User", ...)`**
  - **الوصف:** توفر هذه العلاقة وصولاً سهلاً إلى كائن `User` الكامل المرتبط بسجل التدقيق، مما يسمح لك بجلب معلومات إضافية عن المستخدم الذي أجرى التغيير بسهولة (e.g., `audit_log_entry.user.username`).
