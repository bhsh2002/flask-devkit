# 6. المفاهيم المعمارية الأساسية

تعتمد `Flask-DevKit` على مجموعة من الأنماط المعمارية المجربة والمختبرة التي تهدف إلى فصل الاهتمامات (Separation of Concerns)، مما يجعل الكود أكثر تنظيمًا وقابلية للصيانة والاختبار. فهم هذه المفاهيم سيساعدك على استخدام المكتبة بفعالية وتوسيعها بثقة.

## البنية متعددة الطبقات (Layered Architecture)

تتبع المكتبة بنية ثلاثية الطبقات تفصل بين واجهة برمجة التطبيقات ومنطق الأعمال والوصول إلى قاعدة البيانات.

```
      طلب HTTP
         │
         ▼
┌──────────────────┐
│   طبقة المسارات  │  (Routes / Views)
│  (التعامل مع HTTP)│  - مسارات API
└──────────────────┘  - التحقق من المدخلات (Schemas)
         │
         ▼
┌──────────────────┐
│   طبقة الخدمات   │  (Services)
│   (منطق الأعمال)  │  - تنسيق العمليات
└──────────────────┘  - تطبيق قواعد العمل
         │
         ▼
┌──────────────────┐
│  طبقة المستودعات │  (Repositories)
│ (الوصول للبيانات)│  - استعلامات قاعدة البيانات (CRUD)
└──────────────────┘
         │
         ▼
┌──────────────────┐
│  قاعدة البيانات  │  (Database)
└──────────────────┘
```

### 1. طبقة المستودع (Repository Layer)

- **الغرض:** هذه هي طبقة الوصول إلى البيانات (Data Access Layer - DAL). مسؤوليتها الوحيدة هي التواصل مع قاعدة البيانات.
- **المكون الرئيسي:** `BaseRepository`.
- **المبادئ:**
    - تحتوي على توابع مثل `create`, `get_by_id`, `paginate`.
    - تتعامل مباشرة مع كائن `db.session` الخاص بـ SQLAlchemy.
    - **لا تحتوي على أي منطق أعمال.** على سبيل المثال، المستودع لا يعرف ما إذا كان يجب إرسال بريد إلكتروني بعد إنشاء مستخدم. هو فقط يقوم بإنشاء سجل المستخدم.

### 2. طبقة الخدمة (Service Layer)

- **الغرض:** هذه هي طبقة منطق الأعمال (Business Logic Layer - BLL). هي التي تنسق العمليات وتطبق قواعد العمل.
- **المكون الرئيسي:** `BaseService`.
- **المبادئ:**
    - تستخدم المستودعات (Repositories) لجلب البيانات وحفظها.
    - تحتوي على منطق العمل الفعلي. على سبيل المثال، قد يحتوي `UserService.create` على منطق للتحقق من قوة كلمة المرور قبل استدعاء `repository.create`.
    - يمكنها استدعاء خدمات أخرى لتنسيق عمليات أكثر تعقيدًا.
    - **لا تعرف شيئًا عن HTTP.** الخدمة لا تهتم بما إذا كان الطلب قادمًا من واجهة برمجة تطبيقات REST أو من أمر CLI.

### 3. طبقة المسارات (Routes Layer)

- **الغرض:** هذه هي طبقة العرض (Presentation Layer). هي نقطة الدخول لطلبات HTTP.
- **المكون الرئيسي:** `APIBlueprint` من `APIFlask`.
- **المبادئ:**
    - تعرف نقاط النهاية (Endpoints) مثل `GET /users` و `POST /users`.
    - تستخدم `apiflask` Schemas للتحقق من صحة البيانات الواردة وتنسيق البيانات الصادرة.
    - يجب أن تكون "نحيفة" (thin). منطقها يجب أن يقتصر على استدعاء تابع واحد في طبقة الخدمة وإرجاع النتيجة.

## نمط وحدة العمل (Unit of Work)

- **الغرض:** ضمان أن مجموعة من العمليات على قاعدة البيانات تتم كوحدة واحدة ذرية (atomic). إما أن تنجح جميعها، أو تفشل جميعها ويتم التراجع عنها.
- **المكون الرئيسي:** المُزين (decorator) `@unit_of_work`.
- **المبادئ:**
    - يتم تطبيقه عادةً على توابع الخدمة (Service methods) التي تقوم بعمليات كتابة (create, update, delete).
    - يقوم تلقائيًا بتنفيذ `db.session.commit()` إذا اكتمل التابع بنجاح.
    - يقوم تلقائيًا بتنفيذ `db.session.rollback()` إذا حدث أي استثناء (exception).
    - هذا يمنع ترك قاعدة البيانات في حالة غير متسقة.

## الفوائد

- **قابلية الاختبار (Testability):** يمكنك اختبار منطق الأعمال (الخدمات) بشكل منفصل تمامًا عن قاعدة البيانات (عن طريق محاكاة المستودعات) وعن طبقة الويب.
- **قابلية الصيانة (Maintainability):** من السهل تحديد مكان تغيير الكود. هل التغيير في منطق الأعمال؟ اذهب إلى الخدمة. هل هو في استعلام قاعدة البيانات؟ اذهب إلى المستودع.
- **المرونة (Flexibility):** يمكنك بسهولة استبدال طبقة بأخرى. على سبيل المثال، يمكنك استبدال `BaseRepository` بواحد مخصص يستخدم قاعدة بيانات مختلفة دون تغيير طبقة الخدمة.
