# 20. نظام التدقيق التلقائي (Automatic Auditing)

توفر `Flask-DevKit` نظام تدقيق تلقائي بالكامل لا يتطلب أي إعداد. يقوم هذا النظام بتسجيل كل عملية إنشاء (Create)، تحديث (Update)، وحذف (Delete) تحدث على نماذج قاعدة البيانات الخاصة بك، مما يوفر مسارًا كاملاً للتغييرات لأغراض الأمان والامتثال وتصحيح الأخطاء.

## كيف يعمل؟

يعمل النظام "بشكل سحري" في الخلفية. بمجرد تهيئة `DevKit`، فإنه يستخدم نظام الأحداث في `SQLAlchemy` للاستماع إلى أي تغييرات على وشك الحدوث في جلسة قاعدة البيانات.

قبل أن يتم حفظ أي تغييرات، يقوم النظام تلقائيًا بإنشاء سجل في جدول `audit_log` يحتوي على المعلومات التالية:

- **`user_id`**: معرف المستخدم الذي قام بتسجيل الدخول وأجرى التغيير.
- **`action`**: نوع الإجراء (`CREATE`, `UPDATE`, `DELETE`).
- **`table_name`**: اسم جدول قاعدة البيانات الذي تأثر.
- **`record_pk`**: المفتاح الأساسي للسجل الذي تم تغييره.
- **`old_values`**: قاموس JSON يحتوي على القيم القديمة للحقول التي تم تغييرها فقط (لعمليات `UPDATE` و `DELETE`).
- **`new_values`**: قاموس JSON يحتوي على القيم الجديدة للحقول التي تم تغييرها (لعمليات `CREATE` و `UPDATE`).

هذا يعني أنك لا تحتاج إلى كتابة أي كود إضافي لتسجيل هذه الأنشطة؛ فالنظام يعتني بها بالكامل.

## مثال عملي

لنفترض أن لديك دورًا باسم "محرر" وتريد تحديث اسمه ليكون أوضح.

**الإجراء:**
تقوم بإرسال طلب `PATCH` إلى `/api/v1/roles/5` (بافتراض أن `id` الدور هو 5).

**الطلب (Request Body):**
```json
{
  "display_name": "Article Editor"
}
```

**النتيجة في قاعدة البيانات:**
سيقوم نظام التدقيق تلقائيًا بإنشاء سجل جديد في جدول `audit_log` يبدو كالتالي:

```json
{
  "id": 1,
  "timestamp": "2025-09-24T12:00:00Z",
  "user_id": 1,
  "action": "UPDATE",
  "table_name": "roles",
  "record_pk": "5",
  "old_values": {
    "display_name": "محرر"
  },
  "new_values": {
    "display_name": "Article Editor"
  }
}
```

بهذا السجل، يمكنك دائمًا معرفة **من** غيّر **ماذا**، **متى**، وما هي القيم **قبل وبعد** التغيير.

## ما الذي يتم تسجيله؟

يتم تسجيل أي تغيير يمر عبر جلسة `SQLAlchemy` التي تديرها `Flask-DevKit`. هذا يشمل:
- التغييرات التي تتم عبر نقاط نهاية API.
- التغييرات التي تتم عبر أوامر CLI المخصصة.
- أي تغييرات تتم برمجيًا طالما أنها تستخدم نفس جلسة `db.session`.
