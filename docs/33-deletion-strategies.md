# 33. استراتيجيات الحذف: الحذف الناعم مقابل الحذف الدائم

توفر `Flask-DevKit` استراتيجيتين مختلفتين لحذف البيانات، مما يمنحك المرونة للاختيار بين السلامة وقابلية التراجع، أو الحذف النهائي للبيانات.

## 1. الحذف الناعم (Soft Deletion)

هذه هي الاستراتيجية الافتراضية والأكثر أمانًا.

### المفهوم
بدلاً من إزالة السجل من قاعدة البيانات، يقوم الحذف الناعم ببساطة بـ "إخفائه" عن طريق وضع طابع زمني في حقل `deleted_at` الخاص بالنموذج (هذا الحقل يأتي من `SoftDeleteMixin`). بشكل افتراضي، جميع استعلامات القراءة في `BaseRepository` تقوم تلقائيًا بتجاهل السجلات التي تحتوي على قيمة في `deleted_at`.

### كيف يتم تفعيله؟
- **عبر الـ API:** `DELETE /api/v1/users/<uuid>`
- **برمجيًا:** `user_service.delete(user_uuid)`

### المزايا
- **آمن وقابل للتراجع:** يمكنك بسهولة استعادة السجلات المحذوفة باستخدام نقطة النهاية `restore`.
- **يحافظ على سلامة البيانات المرجعية:** لا يتم كسر المفاتيح الخارجية (Foreign Keys)، حيث أن السجل لا يزال موجودًا.
- **التدقيق:** يمكنك دائمًا الاستعلام عن السجلات المحذوفة لأغراض التدقيق عن طريق استخدام فلتر `deleted_state`.

### استرجاع السجلات المحذوفة
يمكنك استرجاع السجلات المحذوفة عبر نقطة النهاية `restore` (التي يجب تفعيلها في `routes_config`) أو برمجيًا:
`user_service.restore(user_uuid)`

## 2. الحذف الدائم (Permanent Deletion / Force Delete)

هذه الاستراتيجية تقوم بإزالة السجل نهائيًا من جدوله الأصلي.

### المفهوم
عند استدعاء الحذف الدائم، تحدث عمليتان:
1.  **الأرشفة:** يتم نسخ السجل بالكامل ككائن JSON وحفظه في جدول `archived_records`. هذا بمثابة شبكة أمان أو سجل تدقيق أخير.
2.  **الحذف:** يتم تنفيذ أمر `DELETE FROM ...` على السجل في جدوله الأصلي، مما يؤدي إلى إزالته نهائيًا.

### كيف يتم تفعيله؟
- **عبر الـ API:** `DELETE /api/v1/users/<uuid>/force`
  - **مهم:** نقطة النهاية هذه تكون **معطلة افتراضيًا** للسلامة. يجب عليك تفعيلها صراحة في `routes_config` إذا كنت بحاجة إليها.
- **برمجيًا:** `user_service.force_delete(user_uuid)`

### المزايا
- **الامتثال للخصوصية:** مفيد لتلبية متطلبات مثل "الحق في النسيان" في GDPR.
- **تنظيف البيانات:** لإزالة البيانات غير الضرورية بشكل دائم من الجداول النشطة.

## مقارنة سريعة

| الميزة | الحذف الناعم (Soft Delete) | الحذف الدائم (Force Delete) |
| :--- | :--- | :--- |
| **الإجراء** | `UPDATE ... SET deleted_at = NOW()` | `DELETE FROM ...` |
| **قابلية التراجع** | نعم (عبر `restore`) | لا |
| **بقاء البيانات الأصلية** | نعم، لكنها مخفية | لا |
| **الأرشفة** | لا | نعم، في جدول `archived_records` |
| **نقطة النهاية الافتراضية** | `DELETE /<id>` | `DELETE /<id>/force` (معطلة افتراضيًا) |

بشكل عام، يوصى باستخدام **الحذف الناعم** لمعظم العمليات اليومية، وحجز **الحذف الدائم** للحالات التي تتطلب إزالة بيانات لا رجعة فيها.
